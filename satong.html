<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>í†µí•© ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€] */
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; display: flex; height: 100dvh; color: #333; overflow: hidden; background-color: #f5f6fa; }
        .sidebar { width: 240px; background-color: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; flex-shrink: 0; user-select: none; overflow-y: auto; transition: 0.3s; }
        .sidebar::-webkit-scrollbar { width: 5px; }
        .sidebar::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 10px; }
        .sidebar-header { padding: 15px; font-weight: bold; font-size: 1.1rem; border-bottom: 1px solid #eee; color: #ffffff; position: sticky; top: 0; background: #3498db; z-index: 10; }
        .menu-group { border-bottom: 1px solid #f0f0f0; }
        .menu-title { padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; color: #555; transition: 0.2s; }
        .menu-title:hover { background-color: #f8f9fa; color: #3498db; }
        .menu-title .icon { font-size: 10px; transition: transform 0.3s; }
        .submenu-container { display: none; background-color: #fcfcfc; padding-bottom: 5px; }
        .submenu-container.open { display: block; } 
        .menu-group.active .icon { transform: rotate(180deg); }
        .submenu-item { padding: 8px 15px 8px 30px; cursor: pointer; font-size: 13px; color: #666; transition: 0.2s; border-left: 3px solid transparent; text-decoration: none; display: block; }
        .submenu-item:hover { background-color: #eef2f5; color: #333; }
        .submenu-item.active { background-color: #e6f7ff; color: #007bff; border-left-color: #007bff; font-weight: bold; }
        .menu-divider { margin: 10px 15px; border-top: 1px solid #ccc; height: 0; }
        .main-content { flex-grow: 1; padding: 0 20px 80px 20px; overflow-y: auto; display: flex; flex-direction: column; -webkit-overflow-scrolling: touch; }
        .content-header { display: flex; align-items: center; border-bottom: 2px solid #007bff; padding: 15px 0 10px 0; margin-bottom: 15px; position: sticky; top: 0; background-color: #f5f6fa; z-index: 20; }
        h2 { margin: 0; font-size: 1.2rem; color: #2c3e50; flex-grow: 1; }
        .refresh-btn { padding: 6px 12px; cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 4px; font-weight: bold; font-size: 12px; margin-left: 10px; }
        .mobile-back-btn { display: none; margin-right: 10px; padding: 6px 12px; background-color: #3498db; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-weight: bold; color: #ffffff; font-size: 12px; }
        .notice-box { background-color: #e8f4fd; color: #2c3e50; padding: 12px 15px; margin-bottom: 15px; border-left: 5px solid #3498db; border-radius: 4px; font-size: 13px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: none; }
        .search-view-container { display: none; flex-direction: column; align-items: center; justify-content: center; padding-top: 50px; animation: fadeIn 0.3s ease-out; }
        .search-box-wrapper { position: relative; width: 100%; max-width: 600px; margin-bottom: 30px; }
        .search-input { width: 100%; padding: 15px 20px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 50px; outline: none; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.02); box-sizing: border-box; }
        .search-input:focus { border-color: #3498db; box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15); }
        .search-btn-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #3498db; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .search-btn-icon:hover { background: #2980b9; transform: translateY(-50%) scale(1.05); }
        .result-card { background: white; width: 100%; max-width: 600px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; overflow: hidden; display: none; margin-bottom: 20px; }
        .result-header { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; color: #555; display: flex; justify-content: space-between; align-items: center; }
        .keyword-badge { background: #3498db; color: #ffffff; padding: 4px 10px; border-radius: 4px; font-size: 14px; }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; }
        .result-item { padding: 20px; text-align: center; border-bottom: 1px solid #eee; border-right: 1px solid #eee; }
        .result-item:nth-child(2n) { border-right: none; }
        .result-item:nth-last-child(-n+2) { border-bottom: none; }
        .res-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        .res-value { font-size: 18px; font-weight: 800; color: #333; }
        .chart-container-box { padding: 20px; height: 300px; position: relative; }
        .power-summary-container { display: none; flex-direction: column; gap: 12px; margin-bottom: 15px; animation: fadeIn 0.4s ease-out; }
        .summary-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .summary-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; display: flex; flex-direction: column; position: relative; }
        .summary-card .label { font-size: 11px; color: #64748b; margin-bottom: 4px; font-weight: bold; display: flex; justify-content: flex-start; align-items: center; gap: 6px; }
        .summary-card .value { font-size: 18px; color: #1e293b; font-weight: 800; margin-bottom: 8px; }
        .trend-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .trend-up { background-color: #fff5f5; color: #e53e3e; } 
        .trend-down { background-color: #f0fff4; color: #38a169; } 
        .gauge-container { width: 100%; height: 6px; background-color: #edf2f7; border-radius: 10px; overflow: hidden; margin-top: auto; }
        .gauge-bar { height: 100%; width: 0%; transition: width 0.8s ease-in-out; }
        .gauge-green { background-color: #48bb78; }
        .gauge-yellow { background-color: #ecc94b; }
        .gauge-red { background-color: #f56565; }
        .summary-card.alert { border: 2px solid #fecaca; background-color: #fff5f5; }
        .charge-status { padding: 12px; border-radius: 8px; font-size: 12.5px; font-weight: bold; text-align: center; display: none; background-color: #fff1f2; color: #be123c; border: 1px dashed #fda4af; }
        .keyword-tabs { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; }
        .keyword-btn { padding: 6px 12px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 4px; font-size: 12px; font-weight: bold; color: #555; }
        .keyword-btn.active { background-color: #3498db; color: white; border-color: #3498db; box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
        table { border-collapse: collapse; width: 100%; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); table-layout: fixed; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        th { background-color: #f8f9fa; font-weight: bold; color: #555; position: sticky; top: 58px; z-index: 10; box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1); }
        tr:hover { background-color: #f9f9f9; }
        .review-table th:nth-child(1) { width: 75px; }
        .review-table th:nth-child(2) { width: 75px; }
        .review-table th:nth-child(3), .review-table td:nth-child(3) { width: 50px; text-align: center; }
        .review-table th:nth-child(4) { width: 250px; }
        .review-table th:nth-child(5) { width: 75px; }
        .review-table th:nth-child(6), .review-table td:nth-child(6) { width: 50px; text-align: center; }
        .rank-table th:nth-child(1) { width: 130px; } 
        .rank-table th:nth-child(2) { width: 90px; } 
        .power-table th:nth-child(2), .power-table td:nth-child(2), .power-table th:nth-child(6), .power-table td:nth-child(6), .power-table th:nth-child(7), .power-table td:nth-child(7) { display: none; }
        .bad-row { background-color: #ffebee !important; }
        .rank-up { color: #e74c3c; font-weight: bold; }
        .rank-down { color: #3498db; font-weight: bold; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center; visibility: hidden; opacity: 0; transition: 0.3s; }
        .overlay.visible { visibility: visible; opacity: 1; }
        .loading-box { background: white; padding: 20px; border-radius: 10px; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { background: white; width: 85%; max-width: 500px; max-height: 80vh; border-radius: 8px; display: flex; flex-direction: column; transform: translateY(20px); transition: 0.3s; overflow: hidden; }
        .overlay.visible .modal { transform: translateY(0); }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; background: #f8f9fa; }
        .close-btn { cursor: pointer; font-size: 20px; color: #888; }
        .modal-body { padding: 20px; overflow-y: auto; line-height: 1.6; font-size: 14px; word-break: break-all; white-space: pre-wrap; }
        @media (max-width: 768px) {
            .sidebar { width: 100%; height: 100dvh; position: absolute; z-index: 100; border-right: none; }
            .main-content { display: none; width: 100%; height: 100dvh; }
            body.show-content .sidebar { display: none; }
            body.show-content .main-content { display: flex; }
            .mobile-back-btn { display: inline-block; }
            .content-header h2 { font-size: 1rem; }
            .review-table th:nth-child(1), .review-table th:nth-child(5) { width: 50px; }
            .review-table th:nth-child(3), .review-table th:nth-child(6) { width: 20px; }
            .review-table th:nth-child(2) { width: 30px; }
            .review-table th:nth-child(4) { width: 100px; }
            .rank-table th:nth-child(1) { width: 55px; }
            .rank-table th:nth-child(2) { width: 25px; }
        }
        .related-card { margin-top: 20px; background: white; width: 100%; max-width: 600px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #eee; overflow: hidden; display: none; }
        .related-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .related-table th { background: #f1f3f5; padding: 10px; font-weight: bold; color: #555; text-align: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; }
        .related-table td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center; color: #333; }
        .related-table tr:last-child td { border-bottom: none; }
        .related-table tr:hover { background-color: #f8f9fa; }
        .kwd-col { text-align: left !important; font-weight: bold; color: #3498db !important; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .skeleton-card { background: white; width: 100%; max-width: 600px; border-radius: 12px; border: 1px solid #eee; overflow: hidden; margin-bottom: 20px; display: none; }
        .skeleton-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .skeleton-body { padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .skeleton-box { background: #f0f0f0; background-image: linear-gradient(90deg, #f0f0f0 25%, #fafafa 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        .sk-title { width: 100px; height: 24px; }
        .sk-badge { width: 150px; height: 24px; border-radius: 12px; }
        .sk-label { width: 60px; height: 14px; margin-bottom: 8px; margin: 0 auto 8px auto; }
        .sk-value { width: 80px; height: 24px; margin: 0 auto; }
        .sk-item { text-align: center; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="overlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <div id="loading-text" class="loading-text">ë°ì´í„° ë™ê¸°í™” ì¤‘...</div>
        </div>
    </div>

    <div id="detail-modal" class="overlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()"> 
            <div class="modal-header">
                <span id="modal-title">ìƒì„¸ ë‚´ìš©</span>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modal-content"></div>
        </div>
    </div>

    <nav class="sidebar">
        <div class="sidebar-header">í†µí•© ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</div>
        <div class="menu-group" id="group-review">
            <div class="menu-title" onclick="toggleGroup('review')">í”Œë ˆì´ìŠ¤ ë¦¬ë·° <span class="icon">â–¼</span></div>
            <div class="submenu-container" id="submenu-review"></div>
        </div>
        <div class="menu-group" id="group-rank">
            <div class="menu-title" onclick="toggleGroup('rank')">í”Œë ˆì´ìŠ¤ ìˆœìœ„ <span class="icon">â–¼</span></div>
            <div class="submenu-container" id="submenu-rank"></div>
        </div>
        <div class="menu-group" id="group-power">
            <div class="menu-title" onclick="toggleGroup('power')">íŒŒì›Œë§í¬ í˜„í™© <span class="icon">â–¼</span></div>
            <div class="submenu-container" id="submenu-power"></div>
        </div>
        <div class="menu-group" id="group-integrated">
            <div class="menu-title" onclick="toggleGroup('integrated')">í†µí•©ê²€ìƒ‰ ë…¸ì¶œ <span class="icon">â–¼</span></div>
            <div class="submenu-container" id="submenu-integrated"></div>
        </div>
        <div class="menu-group" id="group-marketing">
            <div class="menu-title" onclick="toggleGroup('marketing')">ë§ˆì¼€íŒ… ë„êµ¬ <span class="icon">â–¼</span></div>
            <div class="submenu-container" id="submenu-marketing"></div>
        </div>
        <div class="menu-group" id="group-bookmark">
            <div class="menu-title" onclick="toggleGroup('bookmark')">ì¦ê²¨ì°¾ê¸° <span class="icon">â–¼</span></div>
            <div class="submenu-container" id="submenu-bookmark"></div>
        </div>
    </nav>

    <main class="main-content">
        <div class="content-header">
            <button class="mobile-back-btn" onclick="showMobileMenu()">&#60; ëª©ë¡</button>
            <h2 id="page-title">ë°ì´í„° ë™ê¸°í™” ì¤‘...</h2>
            <button class="refresh-btn" onclick="initDashboard(true)">ìƒˆë¡œê³ ì¹¨ â†»</button>
        </div>
        
        <div id="notice-box" class="notice-box"></div>

        <div id="power-summary" class="power-summary-container">
            <div class="summary-cards-grid">
                <div class="summary-card" id="balance-card">
                    <div class="label">ê´‘ê³  ì”ì•¡ * ì•„ì¹¨ 9ì‹œ ê¸°ì¤€ <span id="d-day-tag" style="font-weight: 800; color: #4a5568;"></span></div>
                    <div class="value" id="current-balance">0ì›</div>
                    <div class="gauge-container"><div id="balance-gauge" class="gauge-bar"></div></div>
                </div>
                <div class="summary-card">
                    <div class="label">1ì¼ í‰ê·  ê´‘ê³ ë¹„ (ìµœê·¼ 7ì¼) <span id="spent-trend" class="trend-tag"></span></div>
                    <div class="value" id="avg-spent">0ì›</div>
                    <div class="gauge-container"><div class="gauge-bar gauge-green" style="width: 100%"></div></div>
                </div>
                <div class="summary-card">
                    <div class="label" id="month-spend-label">ì›” ê´‘ê³ ë¹„ ì‚¬ìš©ì•¡</div>
                    <div class="value" id="month-spend-val">0ì›</div>
                </div>
                <div class="summary-card">
                    <div class="label" id="month-charge-label">ì›” ê´‘ê³ ë¹„ ì¶©ì „ì•¡</div>
                    <div class="value" id="month-charge-val">0ì›</div>
                </div>
            </div>
            <div id="charge-alert" class="charge-status">âš ï¸ ì”ì•¡ì´ ë§¤ìš° ë¶€ì¡±í•©ë‹ˆë‹¤! <br>1~2ì¼ ì´ë‚´ ì†Œì§„ ì˜ˆìƒë˜ì˜¤ë‹ˆ ì¦‰ì‹œ ì¶©ì „í•˜ì„¸ìš”.</div>
        </div>

        <div id="keyword-container" class="keyword-tabs"></div>
        <div id="table-container"></div>

        <div id="marketing-search-view" class="search-view-container">
            <div class="search-box-wrapper">
                <input type="text" id="naver-kwd-input" class="search-input" placeholder="ì¡°íšŒí•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¬ëŒê³¼ì†Œí†µ)" onkeypress="if(event.key === 'Enter') searchNaverKeyword()">
                <button class="search-btn-icon" onclick="searchNaverKeyword()">ğŸ”</button>
            </div>
            
            <div id="skeleton-ui" class="skeleton-card">
                <div class="skeleton-header">
                    <div class="skeleton-box sk-title"></div>
                    <div class="skeleton-box sk-badge"></div>
                </div>
                <div class="skeleton-body">
                    <div class="sk-item"><div class="skeleton-box sk-label"></div><div class="skeleton-box sk-value"></div></div>
                    <div class="sk-item"><div class="skeleton-box sk-label"></div><div class="skeleton-box sk-value"></div></div>
                    <div class="sk-item"><div class="skeleton-box sk-label"></div><div class="skeleton-box sk-value"></div></div>
                    <div class="sk-item"><div class="skeleton-box sk-label"></div><div class="skeleton-box sk-value"></div></div>
                </div>
            </div>

            <div id="kwd-result-card" class="result-card">
                <div class="result-header">
                    <span id="main-card-title">ë¶„ì„ ê²°ê³¼</span> 
                    <span id="res-keyword" class="keyword-badge"></span>
                </div>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="res-label">ì›”ê°„ ê²€ìƒ‰ìˆ˜ (PC)</div>
                        <div class="res-value" id="res-pc-cnt">-</div>
                    </div>
                    <div class="result-item">
                        <div class="res-label">ì›”ê°„ ê²€ìƒ‰ìˆ˜ (Mobile)</div>
                        <div class="res-value" id="res-mo-cnt">-</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="res-label">ì›”í‰ê·  í´ë¦­ìˆ˜ (PC)</div>
                        <div class="res-value" id="res-pc-clk">-</div>
                    </div>
                    <div class="result-item">
                        <div class="res-label">ì›”í‰ê·  í´ë¦­ìˆ˜ (Mobile)</div>
                        <div class="res-value" id="res-mo-clk">-</div>
                    </div>

                    <div class="result-item">
                        <div class="res-label">í‰ê·  í´ë¦­ë¥  (PC)</div>
                        <div class="res-value" id="res-pc-ctr">-</div>
                    </div>
                    <div class="result-item">
                        <div class="res-label">í‰ê·  í´ë¦­ë¥  (Mobile)</div>
                        <div class="res-value" id="res-mo-ctr">-</div>
                    </div>
                </div>
                <div class="chart-container-box">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div id="related-result-card" class="related-card">
                <div class="result-header">
                    <span>ì—°ê´€ê²€ìƒ‰ì–´ - 30ê°œ</span>
                </div>
                <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
                    <table class="related-table">
                        <thead>
                            <tr>
                                <th style="width: 34%">í‚¤ì›Œë“œ</th>
                                <th style="width: 22%">PC ê²€ìƒ‰ìˆ˜</th>
                                <th style="width: 22%">Mo ê²€ìƒ‰ìˆ˜</th>
                                <th style="width: 22%; color: #e74c3c;">Total</th> 
                            </tr>
                        </thead>
                        <tbody id="related-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>



<script>
    const CONFIG = {
        bookmark: { url: "https://script.google.com/macros/s/AKfycbzv5mQQERuRuKQPCxT7X-HPTa-dMfkJR6XCFmQCQiXSlVEmFHsShj01PcuAb6csWJB4/exec", title: "ì¦ê²¨ì°¾ê¸°" },
        review: { 
            urls: [
                "https://script.google.com/macros/s/AKfycbxxg_DqI5cLfTT1Nx73CCl7_dVVjeP9NbdaCUvr5SBKm7VMr19ZjClofZ_ggm0O6dtC/exec",
                "https://script.google.com/macros/s/AKfycbw2Y77qidHEu5OdCFeVb5SrbDkFBt_IKqOJIcb3ltuWIAPXydPL5K826MDxdvWa4mhCqw/exec"
            ], 
            title: "ë¦¬ë·° ëª¨ë‹ˆí„°ë§" 
        },
        rank: { url: "https://script.google.com/macros/s/AKfycbya7-b5zXTEM7xGnM6jfuJHuqnvDgVS1Pvo5CsxBetBqELjDUR8GoEvRFg8WeZv8G9o/exec", title: "ìˆœìœ„ í˜„í™©" },
        power: { url: "https://script.google.com/macros/s/AKfycbzJI5NLmLt8uU5dXCoWbZAx9sZCSHh6mGkiECGTfaTXXPFTmCe7c4RxEoDbiJBF2hRM/exec", title: "íŒŒì›Œë§í¬ í˜„í™©" },
        integrated: { url: "https://script.google.com/macros/s/AKfycbyYQDgn2QdOYhDwoCpHHNbUNEK5gcW5hbAZ6nyhIel_n8gQ4r3aM_O9uQEL06LqDX5x/exec", title: "í†µí•©ê²€ìƒ‰ ë…¸ì¶œ" },
        marketing: { url: "https://script.google.com/macros/s/AKfycbz1PL3THIbulUe4e6G9NPWMOTs3Cce5xidaC9_PZtLcpTAGjoBs7XP9kBnbNSzEfjsY/exec", title: "ë§ˆì¼€íŒ… ë„êµ¬" } 
    };

    const NOTICE_MESSAGES = {
        review: "ğŸ“¢ <b>Notice:</b> ì˜¤ì „(ë‹¨ì–´ í•„í„°ë§ + AI ê²€ìˆ˜), ì˜¤í›„(AI ê²€ìˆ˜) ì´ 2íšŒ ì§„í–‰(<b>ë¦¬ë·° ëª©ë¡ 2íšŒ ì—…ë°ì´íŠ¸</b>), ë¶€ì • ë¦¬ë·° ë°œê²¬ ì‹œ ì´ë©”ì¼ ë°œì†¡í•©ë‹ˆë‹¤.",
        rank: "ğŸ“¢ <b>Notice:</b> <b>ì˜¤ì „, ì˜¤í›„ ì´ 2íšŒ ë…¸ì¶œ ìˆœìœ„ í™•ì¸</b>, ìˆœìœ„ ë³€ë™ì€ â–² ìƒìŠ¹/â–¼ í•˜ë½ìœ¼ë¡œ í‘œì‹œë˜ê³ , 50ìœ„ ë¯¸ë§Œì€ ê¸°ë¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
        power: "ğŸ“¢ <b>Notice:</b> <b>ìµœê·¼ 7ì¼ ì†Œì§„ì•¡ ë° ì”ì•¡ ê¸°ë°˜ìœ¼ë¡œ ë¶„ì„í•œ ê´‘ê³ ë¹„ í˜„í™©ì…ë‹ˆë‹¤.</b>",
        integrated: "ğŸ“¢ <b>Notice:</b> <b>í†µí•©ê²€ìƒ‰ ë…¸ì¶œ í˜„í™©</b>ì…ë‹ˆë‹¤. ìµœê·¼ 2ì¼ì¹˜ ë…¸ì¶œ ìˆœìœ„ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.",
        marketing: "ğŸ“¢ <b>Notice:</b> <b>ë„¤ì´ë²„ ê²€ìƒ‰ê´‘ê³  API</b>ì™€ <b>ë°ì´í„°ë© API</b>ë¥¼ ê²°í•©í•œ ì¶”ì • ë°ì´í„°ì…ë‹ˆë‹¤. ê·¸ë˜í”„ëŠ” ë°ì´í„°ë© íŠ¸ë Œë“œ ì§€ìˆ˜ë¥¼ ì‹¤ì œ ê²€ìƒ‰ëŸ‰ìœ¼ë¡œ ì—­ì‚°í•œ ìˆ˜ì¹˜ì…ë‹ˆë‹¤."
    };

    const REVIEW_COMPANY_COL_IDX = 0; 
    const RANK_KEYWORD_COL_IDX = 1; 

    let dataCache = { 
        review: {}, rank: null, power: null, bookmark: null, integrated: null, 
        marketing: { "ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ": [] } 
    };

    let orderCache = { review: [], rank: [], power: [], integrated: [] };
    let loadingStatus = { review: false, rank: false, power: false, bookmark: false, integrated: false, marketing: false };
    
    let trendChartInstance = null;

    history.replaceState(null, '', location.pathname + location.search);

    function parseKoreanDate(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return new Date(0);
        const matches = dateStr.match(/(\d+)ë…„\s*(\d+)ì›”\s*(\d+)ì¼/);
        return matches ? new Date(matches[1], matches[2] - 1, matches[3]) : new Date(0);
    }

    function cleanNum(val) { return Number(String(val).replace(/[^0-9.-]+/g,"")) || 0; }

    function showOverlay(text) {
        const overlay = document.getElementById('loading-overlay');
        document.getElementById('loading-text').innerText = text || "ë°ì´í„° ë™ê¸°í™” ì¤‘...";
        overlay.classList.add('visible');
    }

    function hideOverlay() {
        document.getElementById('loading-overlay').classList.remove('visible');
    }

    async function initDashboard(isRefresh = false) {
        const urlParams = new URLSearchParams(window.location.search);
        const userKey = urlParams.get('id');
        if (!userKey) { alert("ID ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

        showOverlay("ë°ì´í„° ë¡œë”© ì¤‘...");
        
        fetchData('bookmark', CONFIG.bookmark.url, userKey);
        await loadReviewData(userKey);
        hideOverlay();
        // ì´ˆê¸° ë¡œë”© ì‹œì—ëŠ” ê°•ì œë¡œ ì—´ê¸° ëª¨ë“œ(true) ì ìš©
        toggleGroup('review', true);

        buildSidebar('marketing', dataCache.marketing, orderCache.marketing);

        fetchData('rank', CONFIG.rank.url, userKey);
        fetchData('power', CONFIG.power.url, userKey);
        fetchData('integrated', CONFIG.integrated.url, userKey);
    }

    async function loadReviewData(userKey) {
        loadingStatus.review = true;
        buildSidebar('review', null, null);
        try {
            const results = await Promise.all(CONFIG.review.urls.map(url => fetch(`${url}?id=${userKey}`).then(r => r.json())));
            let mergedData = {};
            let mergedOrder = [];
            results.forEach(res => {
                if (!res) return;
                const sheets = res.sheets || res;
                Object.keys(sheets).forEach(key => {
                    if (!['error', 'status', 'order'].includes(key)) mergedData[key] = sheets[key];
                });
                if (res.order) mergedOrder = mergedOrder.concat(res.order);
            });
            dataCache.review = mergedData;
            orderCache.review = [...new Set([...mergedOrder, ...Object.keys(mergedData)])];
            buildSidebar('review', dataCache.review, orderCache.review);
            let firstSheet = orderCache.review.find(name => dataCache.review[name]) || Object.keys(dataCache.review)[0];
            if (firstSheet) selectClinic('review', firstSheet, true, true);
        } catch (e) { console.error(e); }
        loadingStatus.review = false;
    }

    async function fetchData(mode, url, userKey) {
        loadingStatus[mode] = true;
        buildSidebar(mode, null, null);
        try {
            const res = await fetch(`${url}?id=${userKey}`).then(r => r.json());
            if (mode === 'bookmark') {
                dataCache.bookmark = res.links;
            } else {
                dataCache[mode] = res.sheets || res;
                orderCache[mode] = res.order || [];
            }
            buildSidebar(mode, dataCache[mode], orderCache[mode]);
        } catch (e) { console.error(e); }
        loadingStatus[mode] = false;
        buildSidebar(mode, dataCache[mode], orderCache[mode]);
    }

    function buildSidebar(mode, data, order) {
        const container = document.getElementById(`submenu-${mode}`);
        if (!container) return;
        container.innerHTML = ""; 

        if (loadingStatus[mode] && (!data || Object.keys(data).length === 0)) {
            container.innerHTML = "<div style='padding:10px; font-size:12px; color:#3498db;'>ëª©ë¡ ë¡œë”© ì¤‘...</div>";
            return;
        }

        if (mode === 'bookmark') {
            if (!data || data.length === 0) {
                if (!loadingStatus.bookmark) container.innerHTML = "<div style='padding:10px; font-size:12px; color:#999'>ë°ì´í„° ì—†ìŒ</div>";
                return;
            }
            data.forEach(item => {
                const itemName = item.name ? String(item.name).trim() : "";
                if (itemName === '-') {
                    const sep = document.createElement('div'); sep.className = 'menu-divider'; container.appendChild(sep); return; 
                }
                const link = document.createElement('a');
                link.className = 'submenu-item'; link.innerText = item.name;
                link.href = item.url.startsWith('http') ? item.url : 'http://' + item.url;
                link.target = "_blank"; link.style.color = "#333";
                container.appendChild(link);
            });
            return;
        }

        let keys = (order && order.length > 0) ? order : Object.keys(data || {});
        if (keys.length === 0 && !loadingStatus[mode]) {
            container.innerHTML = "<div style='padding:10px; font-size:12px; color:#999'>ë°ì´í„° ì—†ìŒ</div>";
            return;
        }

        keys.forEach(function(sheetName) {
            if (mode === 'power' && !sheetName.includes("(íŒŒì›Œë§í¬)")) return;
            if (mode !== 'power' && sheetName.includes("(íŒŒì›Œë§í¬)")) return;
            if (!data[sheetName]) return;

            const item = document.createElement('div');
            item.className = 'submenu-item';
            item.id = `nav-${mode}-${sheetName}`; 
            
            let displayName = sheetName.replace('(íŒŒì›Œë§í¬)', '');
            if (mode === 'integrated') {
                displayName = displayName.replace(' ë…¸ì¶œ (í†µí•©ê²€ìƒ‰)', '').trim();
            }
            item.innerText = displayName;
            
            item.onclick = () => selectClinic(mode, sheetName, false, false);
            container.appendChild(item);
        });
    }

    // [ìˆ˜ì •ëœ í•¨ìˆ˜] forceOpen íŒŒë¼ë¯¸í„° ì¶”ê°€
    // forceOpenì´ trueë©´ í† ê¸€í•˜ì§€ ì•Šê³  ë¬´ì¡°ê±´ ì—½ë‹ˆë‹¤.
    function toggleGroup(mode, forceOpen = false) {
        const targetGroup = document.getElementById(`group-${mode}`);
        const targetSubmenu = document.getElementById(`submenu-${mode}`);
        
        // ë°ì´í„° ë¡œë”© ì¤‘ ì²´í¬
        if (loadingStatus[mode] && (!dataCache[mode] || Object.keys(dataCache[mode]).length === 0)) {
            const isAlreadyActive = targetGroup.classList.contains('active');
            if (!isAlreadyActive) { // ë‹«í˜€ìˆì„ ë•Œë§Œ ë¡œë”© í‘œì‹œ
                showOverlay(`ë°ì´í„° ë¡œë”© ì¤‘...`);
                const checkTimer = setInterval(() => {
                    if (!loadingStatus[mode]) {
                        clearInterval(checkTimer);
                        hideOverlay();
                        if (!targetGroup.classList.contains('active')) toggleGroup(mode, forceOpen);
                    }
                }, 500);
            }
            return;
        }

        const isAlreadyOpen = targetGroup.classList.contains('active');

        // ë‹¤ë¥¸ ë©”ë‰´ë“¤ì€ ëª¨ë‘ ë‹«ê¸° (ì•„ì½”ë””ì–¸ íš¨ê³¼)
        document.querySelectorAll('.menu-group').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.submenu-container').forEach(el => el.classList.remove('open'));

        // [í•µì‹¬] ê°•ì œ ì—´ê¸° ëª¨ë“œì´ê±°ë‚˜, ì›ë˜ ë‹«í˜€ìˆì—ˆë‹¤ë©´ -> ì—°ë‹¤.
        // ì›ë˜ ì—´ë ¤ìˆì—ˆëŠ”ë° forceOpenì´ false(ë‹¨ìˆœ ëŒ€ë©”ë‰´ í´ë¦­)ë¼ë©´ -> ë‹«íŒ ìƒíƒœ ìœ ì§€(ìœ„ì—ì„œ remove í–ˆìœ¼ë¯€ë¡œ).
        if (forceOpen || !isAlreadyOpen) {
            targetGroup.classList.add('active');
            targetSubmenu.classList.add('open');
        }
    }

    function selectClinic(mode, sheetName, isInitial = false, isHistorySkip = false) {
        if (mode === 'bookmark') return;
        
        if (!isHistorySkip && !isInitial) {
             history.pushState({ mode: mode, sheet: sheetName }, '', '#detail');
        }

        if (loadingStatus[mode]) {
            showOverlay(`ë°ì´í„° ë¡œë”© ì¤‘...`);
            const checkDataTimer = setInterval(() => {
                if (!loadingStatus[mode]) {
                    clearInterval(checkDataTimer);
                    hideOverlay();
                    renderContentNow(mode, sheetName, isInitial);
                }
            }, 500);
            return;
        }
        renderContentNow(mode, sheetName, isInitial);
    }

    function renderContentNow(mode, sheetName, isInitial) {
        document.querySelectorAll('.submenu-item').forEach(el => el.classList.remove('active'));
        const currentItem = document.getElementById(`nav-${mode}-${sheetName}`);
        
        // [ìˆ˜ì •] ì†Œë©”ë‰´ ì§„ì… ì‹œì—ëŠ” 'ë¬´ì¡°ê±´ ì—´ê¸°(true)' ì˜µì…˜ ì‚¬ìš©
        toggleGroup(mode, true); 

        if (currentItem) currentItem.classList.add('active');

        document.getElementById('page-title').innerText = `[${CONFIG[mode].title}] ${sheetName.replace('(íŒŒì›Œë§í¬)', '')}`;
        const noticeBox = document.getElementById('notice-box');
        noticeBox.innerHTML = NOTICE_MESSAGES[mode] || "";
        noticeBox.style.display = 'block';
        renderContent(mode, dataCache[mode][sheetName]);
        
        if (!isInitial) showMobileContent();
    }

    function showMobileContent() {
        document.body.classList.add('show-content');
    }

    function showMobileMenu() {
        history.back();
    }

    function renderContent(mode, rows) {
        const keywordContainer = document.getElementById('keyword-container');
        const tableContainer = document.getElementById('table-container');
        const powerSummary = document.getElementById('power-summary');
        const searchView = document.getElementById('marketing-search-view');

        keywordContainer.innerHTML = "";
        tableContainer.innerHTML = "";
        powerSummary.style.display = "none";
        if(searchView) searchView.style.display = "none";

        if (mode === 'marketing') {
            if(searchView) searchView.style.display = "flex";
            return;
        }

        if (!rows || rows.length < 1) {
            tableContainer.innerHTML = "<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
        }

        if (mode === 'review') {
            const header = rows[0];
            const body = rows.slice(1);
            body.sort((a, b) => parseKoreanDate(a[1]) - parseKoreanDate(b[1]));
            tableContainer.innerHTML = createTable([header, ...body], mode, false);
        }
        else if (mode === 'rank') {
            const header = rows[0];
            const body = rows.slice(1);
            const keywords = [...new Set(body.map(r => r[RANK_KEYWORD_COL_IDX]))].filter(k => k);
            keywords.forEach((keyword, idx) => {
                const btn = document.createElement('button');
                btn.className = `keyword-btn ${idx === 0 ? 'active' : ''}`;
                btn.innerText = keyword;
                btn.onclick = () => {
                    document.querySelectorAll('.keyword-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const filtered = body.filter(r => r[RANK_KEYWORD_COL_IDX] === keyword);
                    tableContainer.innerHTML = createTable([header, ...filtered], mode, true);
                };
                keywordContainer.appendChild(btn);
            });
            if (keywords.length > 0) {
                const filtered = body.filter(r => r[RANK_KEYWORD_COL_IDX] === keywords[0]);
                tableContainer.innerHTML = createTable([header, ...filtered], mode, true);
            }
        }
        else if (mode === 'integrated') {
            const header = rows[0];
            const body = rows.slice(1);
            tableContainer.innerHTML = createTable([header, ...body], 'integrated', false);
        }
        else if (mode === 'power') {
            const body = rows.slice(1);
            if (body.length > 0) {
                const lastRow = body[body.length - 1];
                const lastDateStr = String(lastRow[0]).trim(); 
                const targetPrefix = lastDateStr.substring(0, 6); 
                const targetMonth = parseInt(lastDateStr.substring(4, 6)); 
                let varMonthSpent = 0, varMonthCharge = 0;
                body.forEach(row => {
                    const rowDate = String(row[0]).trim(); 
                    if (rowDate.startsWith(targetPrefix)) {
                        varMonthSpent += cleanNum(row[3]); varMonthCharge += cleanNum(row[4]); 
                    }
                });
                document.getElementById('month-spend-label').innerText = `${targetMonth}ì›” ê´‘ê³ ë¹„ ì‚¬ìš©ì•¡`;
                document.getElementById('month-spend-val').innerText = varMonthSpent.toLocaleString() + "ì›";
                document.getElementById('month-charge-label').innerText = `${targetMonth}ì›” ê´‘ê³ ë¹„ ì¶©ì „ì•¡`;
                document.getElementById('month-charge-val').innerText = varMonthCharge.toLocaleString() + "ì›";
                const last7 = body.slice(-7);
                const avgSpent = Math.round(last7.reduce((acc, r) => acc + cleanNum(r[3]), 0) / (last7.length || 1));
                const trendTag = document.getElementById('spent-trend');
                if (body.length >= 10) {
                    const prev7 = body.slice(-14, -7);
                    const prevAvg = Math.round(prev7.reduce((acc, r) => acc + cleanNum(r[3]), 0) / (prev7.length || 1));
                    const diff = ((avgSpent - prevAvg) / (prevAvg || 1)) * 100;
                    trendTag.innerText = (diff >= 0 ? "â–² " : "â–¼ ") + Math.abs(diff).toFixed(1) + "%";
                    trendTag.className = "trend-tag " + (diff >= 0 ? "trend-up" : "trend-down");
                    trendTag.style.display = "inline-block";
                } else { trendTag.style.display = "none"; }
                const latestBalance = cleanNum(body[body.length - 1][6]); 
                const remainingDays = avgSpent > 0 ? (latestBalance / avgSpent).toFixed(1) : 0;
                document.getElementById('avg-spent').innerText = avgSpent.toLocaleString() + "ì›";
                document.getElementById('current-balance').innerText = latestBalance.toLocaleString() + "ì›";
                document.getElementById('d-day-tag').innerText = `(D-${Math.floor(remainingDays)}ì¼ë¶„)`;
                const gauge = document.getElementById('balance-gauge');
                const gaugePercent = Math.min((remainingDays / 10) * 100, 100);
                gauge.style.width = gaugePercent + "%";
                const alertBox = document.getElementById('charge-alert'), balCard = document.getElementById('balance-card');
                if (remainingDays < 2) {
                    alertBox.style.display = "block"; balCard.classList.add('alert'); gauge.className = "gauge-bar gauge-red";
                } else if (remainingDays < 5) {
                    alertBox.style.display = "none"; balCard.classList.remove('alert'); gauge.className = "gauge-bar gauge-yellow";
                } else {
                    alertBox.style.display = "none"; balCard.classList.remove('alert'); gauge.className = "gauge-bar gauge-green";
                }
                powerSummary.style.display = "flex";
            }
            tableContainer.innerHTML = createTable(rows, mode, false);
        }
    }

    function createTable(rows, mode, hideKeywordCol) {
        let html = `<table class="${mode === 'review' ? 'review-table' : (mode === 'power' ? 'power-table' : 'rank-table')}"><thead><tr>`;
        
        for (let j = 0; j < rows[0].length; j++) {
            if (mode === 'review' && j === REVIEW_COMPANY_COL_IDX) continue;
            if (mode === 'rank' && hideKeywordCol && j === RANK_KEYWORD_COL_IDX) continue;
            
            let headVal = rows[0][j] || '';
            if (mode === 'integrated' && j >= rows[0].length - 2) {
                headVal = String(headVal).trim().replace(/^20/, '');
            }
            html += `<th>${headVal}</th>`;
        }
        html += '</tr></thead><tbody>';

        for (let i = 1; i < rows.length; i++) {
            const isBad = (mode === 'review' && String(rows[i][3]).startsWith("O"));
            html += `<tr${isBad ? ' class="bad-row"' : ''}>`;
            for (let j = 0; j < rows[i].length; j++) {
                if (mode === 'review' && j === REVIEW_COMPANY_COL_IDX) continue;
                if (mode === 'rank' && hideKeywordCol && j === RANK_KEYWORD_COL_IDX) continue;
                
                let val = rows[i][j] !== null ? rows[i][j] : '';

                if (mode === 'review') {
                    if (j === 1) {
                        const m = String(val).match(/(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
                        if (m) val = `${m[1].replace(/^20/,'')}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
                    } else if (j === 5) val = String(val).replace(/^20/, '');
                } else if (mode === 'rank' && j === 0) val = String(val).replace(/^20/, '');
                else if (mode === 'power' && j === 0) val = String(val).replace(/^20(\d{2})(\d{2})(\d{2})$/, '$1-$2-$3');
                else if (mode === 'integrated' && j >= rows[i].length - 2) {
                    val = String(val).trim().replace(/^20/, '');
                }

                let cls = (mode === 'rank' || mode === 'power') && (String(val).includes('â–²') || String(val).includes('â–¼')) ? (String(val).includes('â–²') ? "rank-up" : "rank-down") : "";
                
                let cellStyle = "";
                if (mode === 'review') {
                     cellStyle = "cursor: pointer;";
                } else if (mode === 'integrated' && j === 3) {
                     cellStyle = "background-color: #fff9c4;"; 
                }

                let evt = mode === 'review' ? ` onclick="openModal('${String(val).replace(/"/g, '&quot;').replace(/'/g, "\\'").replace(/\n/g, '\\n')}')"` : "";
                
                html += `<td class="${cls}"${evt} style="${cellStyle}">${val}</td>`;
            }
            html += '</tr>';
        }
        return html + '</tbody></table>';
    }

    function openModal(content) { document.getElementById('modal-content').innerText = content; document.getElementById('detail-modal').classList.add('visible'); }
    function closeModal() { document.getElementById('detail-modal').classList.remove('visible'); }

    const safeNum = (val) => {
        if (val === undefined || val === null || val === "") return 0;
        const num = Number(val);
        return isNaN(num) ? 0 : num;
    };
    const getRealNum = (val) => {
        if (typeof val === 'string' && val.includes('<')) return 0;
        return Number(val) || 0;
    };
    const safeStrNum = (val) => {
        if (typeof val === 'string' && val.includes('<')) return val; 
        return safeNum(val).toLocaleString();
    };

    async function searchNaverKeyword() {
        const input = document.getElementById('naver-kwd-input');
        const keyword = input.value.trim();
        if (!keyword) { alert("í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

        const skeleton = document.getElementById('skeleton-ui');
        const mainCard = document.getElementById('kwd-result-card');
        const relatedCard = document.getElementById('related-result-card');
        const btn = document.querySelector('.search-btn-icon');
        const inputField = document.querySelector('.search-input');
        const tbody = document.getElementById('related-table-body');

        mainCard.style.display = "none";
        relatedCard.style.display = "none";
        skeleton.style.display = "block";
        btn.disabled = true;
        inputField.disabled = true;
        inputField.style.opacity = "0.7"; 
        
        try {
            const res = await fetch(`${CONFIG.marketing.url}?keyword=${keyword}`).then(r => r.json());
            
            if (res.status === 'success' && res.data) {
                const d = res.data.main; 
                const list = res.data.related;
                const trendData = res.data.trend || []; 

                const mainTitle = document.getElementById('main-card-title');
                if(mainTitle) mainTitle.innerText = d.relKeyword || keyword;

                let mainTotal = getRealNum(d.monthlyPcQcCnt) + getRealNum(d.monthlyMobileQcCnt);
                document.getElementById('res-keyword').innerText = `ìµœê·¼ 30ì¼ ê²€ìƒ‰ìˆ˜ ${mainTotal.toLocaleString()}`;

                document.getElementById('res-pc-cnt').innerText = safeStrNum(d.monthlyPcQcCnt);
                document.getElementById('res-mo-cnt').innerText = safeStrNum(d.monthlyMobileQcCnt);
                document.getElementById('res-pc-clk').innerText = safeNum(d.monthlyAvePcClkCnt).toFixed(1);
                document.getElementById('res-mo-clk').innerText = safeNum(d.monthlyAveMobileClkCnt).toFixed(1);
                document.getElementById('res-pc-ctr').innerText = safeNum(d.monthlyAvePcCtr).toFixed(2) + "%";
                document.getElementById('res-mo-ctr').innerText = safeNum(d.monthlyAveMobileCtr).toFixed(2) + "%";

                renderTrendChart(trendData, mainTotal);

                tbody.innerHTML = ""; 
                if (list && list.length > 0) {
                    const fragment = document.createDocumentFragment(); 
                    list.forEach(item => {
                        const tr = document.createElement('tr');
                        const tdKwd = document.createElement('td'); tdKwd.className = "kwd-col"; tdKwd.innerText = item.relKeyword;
                        const tdPc = document.createElement('td'); tdPc.innerText = safeStrNum(item.monthlyPcQcCnt);
                        const tdMo = document.createElement('td'); tdMo.innerText = safeStrNum(item.monthlyMobileQcCnt);
                        let totalSum = getRealNum(item.monthlyPcQcCnt) + getRealNum(item.monthlyMobileQcCnt);
                        const tdTotal = document.createElement('td'); tdTotal.innerText = totalSum.toLocaleString(); tdTotal.style.fontWeight = "bold"; tdTotal.style.color = "#333";
                        tr.appendChild(tdKwd); tr.appendChild(tdPc); tr.appendChild(tdMo); tr.appendChild(tdTotal);
                        fragment.appendChild(tr); 
                    });
                    tbody.appendChild(fragment);
                    relatedCard.style.display = "block"; 
                }
                skeleton.style.display = "none";
                mainCard.style.display = "block"; 

            } else {
                alert("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + (res.message || "ê²°ê³¼ ì—†ìŒ"));
                skeleton.style.display = "none";
            }
        } catch (e) {
            console.error(e);
            alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            skeleton.style.display = "none";
        } finally {
            btn.disabled = false;
            inputField.disabled = false;
            inputField.style.opacity = "1";
            inputField.focus();
        }
    }

    function renderTrendChart(trendList, recentTotalVolume) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        
        if (trendChartInstance) {
            trendChartInstance.destroy();
        }

        if (!trendList || trendList.length === 0) {
            document.querySelector('.chart-container-box').style.display = 'none';
            return;
        }
        document.querySelector('.chart-container-box').style.display = 'block';

        let recentDays = trendList.slice(-31, -1);
        if (recentDays.length < 30) {
            recentDays = trendList.slice(-30); 
        }

        let sumOfRatios = 0;
        recentDays.forEach(day => {
            sumOfRatios += Number(day.ratio || 0);
        });

        let multiplier = 0;
        if (sumOfRatios > 0) {
            multiplier = recentTotalVolume / sumOfRatios;
        }

        let monthlyMap = {};
        trendList.forEach(item => {
            let monthKey = item.period.substring(0, 7); 
            if (!monthlyMap[monthKey]) {
                monthlyMap[monthKey] = 0;
            }
            monthlyMap[monthKey] += Number(item.ratio || 0);
        });

        const labels = [];
        const estimatedVolumes = [];

        Object.keys(monthlyMap).sort().forEach(key => {
            labels.push(key.slice(2).replace('-', '.')); 
            estimatedVolumes.push(Math.round(monthlyMap[key] * multiplier));
        });

        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ì›”ë³„ ì˜ˆìƒ ê²€ìƒ‰ìˆ˜',
                    data: estimatedVolumes,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#3498db',
                    pointHoverBackgroundColor: '#3498db',
                    pointHoverBorderColor: '#fff',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 13 },
                        bodyFont: { size: 13, weight: 'bold' },
                        padding: 10,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return ` ì˜ˆìƒ: ${context.parsed.y.toLocaleString()}íšŒ`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f0f0f0', drawBorder: false },
                        ticks: {
                            callback: function(value) {
                                if(value >= 10000) return (value/10000).toFixed(1) + 'ë§Œ';
                                return value.toLocaleString();
                            },
                            font: { size: 11, family: "'Malgun Gothic', sans-serif" },
                            padding: 8
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { 
                            font: { size: 11, family: "'Malgun Gothic', sans-serif" },
                            maxRotation: 0
                        }
                    }
                }
            }
        });
    }

    initDashboard();

    document.addEventListener('contextmenu', e => { e.preventDefault(); alert('ìš°í´ë¦­ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); });
    document.addEventListener('keydown', e => {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key)) || (e.ctrlKey && e.key === 'U')) {
            e.preventDefault(); e.returnValue = false;
        }
    });

    window.addEventListener('popstate', function(event) {
        if (!event.state) {
            document.body.classList.remove('show-content');
        } else {
            if (event.state.mode && event.state.sheet) {
                selectClinic(event.state.mode, event.state.sheet, false, true);
            }
            document.body.classList.add('show-content');
        }
    });

    (function() {
        const threshold = 160;
        const main = () => {
            const start = new Date().getTime();
            debugger; 
            const end = new Date().getTime();
            if (end - start > threshold) devtoolsOpen();
        };
        const devtoolsOpen = () => {
            document.body.innerHTML = '<h1>ì ‘ì† ì°¨ë‹¨ë¨</h1>';
            document.body.style.backgroundColor = 'white';
        };
        setInterval(main, 1000);
    })();
</script>

</body>
</html>
